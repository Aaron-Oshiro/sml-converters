{
  "$id": "https://www.atscale.com/ml/dimension.schema.json",
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "Dimension",
  "type": "object",
  "required": ["label", "hierarchies", "level_attributes", "unique_name", "object_type"],
  "properties": {
    "label": {
      "type": "string",
      "minLength": 1,
      "maxLength": 63
    },
    "description": {
      "type": "string",
      "minLength": 1
    },
    "type": {
      "enum": ["time", "standard"],
      "errorMessage": "must have a value: 'time' or 'standard'"
    },
    "hierarchies": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["label", "unique_name", "levels"],
        "properties": {
          "label": {
            "type": "string",
            "minLength": 1,
            "maxLength": 128
          },
          "unique_name": {
            "type": "string",
            "minLength": 1,
            "maxLength": 63
          },
          "levels": {
            "type": "array",
            "items": {
              "type": "object",
              "required": ["unique_name"],
              "properties": {
                "unique_name": {
                  "type": "string",
                  "minLength": 1,
                  "maxLength": 63
                },
                "secondary_attributes": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "required": ["unique_name", "label", "dataset", "name_column", "key_columns"],
                    "properties": {
                      "label": {
                        "type": "string",
                        "minLength": 1,
                        "maxLength": 128
                      },
                      "unique_name": {
                        "type": "string",
                        "minLength": 1,
                        "maxLength": 63
                      },
                      "dataset": {
                        "type": "string",
                        "minLength": 1,
                        "maxLength": 128
                      },
                      "name_column": {
                        "type": "string",
                        "minLength": 1
                      },
                      "key_columns": {
                        "type": "array"
                      },
                      "sort_column": {
                        "type": "string",
                        "minLength": 1
                      },
                      "description": {
                        "type": "string",
                        "minLength": 1
                      },
                      "is_hidden": {
                        "type": "boolean"
                      },
                      "folder": {
                        "type": "string",
                        "minLength": 1,
                        "maxLength": 128
                      },
                      "contains_unique_names": {
                        "type": "boolean"
                      },
                      "allowed_calcs_for_dma": {
                        "type": "array",
                        "items": {
                          "type": "string",
                          "minLength": 1
                        }
                      },
                      "exclude_from_dim_agg": {
                        "type": "boolean"
                      },
                      "is_aggregatable": {
                        "type": "boolean"
                      },
                      "exclude_from_fact_agg": {
                        "type": "boolean"
                      },
                      "custom_empty_member": {
                        "type": "object",
                        "required": ["key", "name"],
                        "properties": {
                          "key": {
                            "type": "array"
                          },
                          "name": {
                            "type": "string",
                            "minLength": 1,
                            "maxLength": 128
                          },
                          "sort": {
                            "type": "string",
                            "minLength": 1
                          }
                        }
                      }
                    }
                  }
                },
                "aliases": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "required": ["unique_name", "label", "dataset", "name_column"],
                    "properties": {
                      "label": {
                        "type": "string",
                        "minLength": 1,
                        "maxLength": 128
                      },
                      "unique_name": {
                        "type": "string",
                        "minLength": 1,
                        "maxLength": 63
                      },
                      "dataset": {
                        "type": "string",
                        "minLength": 1,
                        "maxLength": 128
                      },
                      "name_column": {
                        "type": "string",
                        "minLength": 1,
                        "maxLength": 128
                      },
                      "sort_column": {
                        "type": "string",
                        "minLength": 1
                      },
                      "description": {
                        "type": "string",
                        "minLength": 1
                      },
                      "is_hidden": {
                        "type": "boolean"
                      },
                      "folder": {
                        "type": "string",
                        "minLength": 1
                      },
                      "format": {
                        "type": "string",
                        "minLength": 1
                      },
                      "exclude_from_dim_agg": {
                        "type": "boolean"
                      },
                      "exclude_from_fact_agg": {
                        "type": "boolean"
                      },
                      "is_aggregatable": {
                        "type": "boolean"
                      },
                      "custom_empty_member": {
                        "type": "object",
                        "required": ["key", "name"],
                        "properties": {
                          "key": {
                            "type": "array",
                            "items": {
                              "type": "string",
                              "minLength": 1
                            }
                          },
                          "name": {
                            "type": "string",
                            "minLength": 1,
                            "maxLength": 128
                          },
                          "sort_name": {
                            "minLength": 1,
                            "maxLength": 128
                          }
                        }
                      }
                    }
                  }
                },
                "metrics": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "required": ["unique_name", "label", "dataset", "column", "calculation_method"],
                    "properties": {
                      "label": {
                        "type": "string",
                        "minLength": 1,
                        "maxLength": 128
                      },
                      "unique_name": {
                        "type": "string",
                        "minLength": 1,
                        "maxLength": 128
                      },
                      "dataset": {
                        "type": "string",
                        "minLength": 1,
                        "maxLength": 128
                      },
                      "column": {
                        "type": "string",
                        "minLength": 1,
                        "maxLength": 128
                      },
                      "calculation_method": {
                        "type": "string",
                        "minLength": 1
                      },
                      "description": {
                        "type": "string",
                        "minLength": 1
                      },
                      "is_hidden": {
                        "type": "boolean"
                      },
                      "folder": {
                        "type": "string",
                        "minLength": 1
                      },
                      "format": {
                        "type": "string",
                        "minLength": 1
                      },
                      "exclude_from_dim_agg": {
                        "type": "boolean"
                      },
                      "is_aggregatable": {
                        "type": "boolean"
                      },
                      "exclude_from_fact_agg": {
                        "type": "boolean"
                      },
                      "custom_empty_member": {
                        "type": "object",
                        "required": ["key", "name", "sort"],
                        "properties": {
                          "key": {
                            "type": "array"
                          },
                          "name": {
                            "type": "string",
                            "minLength": 1
                          },
                          "sort": {
                            "type": "string",
                            "minLength": 1
                          }
                        }
                      },
                      "unrelated_dimensions_handling": {
                        "enum": ["error", "repeat", "empty"],
                        "errorMessage": "Type must be: 'error', 'repeat', 'empty'"
                      }
                    }
                  }
                },
                "parallel_periods": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "required": ["level", "key_columns"],
                    "properties": {
                      "level": {
                        "type": "string",
                        "minLength": 1
                      },
                      "key_columns": {
                        "type": "array",
                        "items": {
                          "type": "string",
                          "minLength": 1
                        },
                        "minItems": 1
                      }
                    }
                  },
                  "minLength": 1
                }
              }
            }
          },
          "description": {
            "type": "string",
            "minLength": 1
          },
          "folder": {
            "type": "string",
            "minLength": 1
          },
          "filter_empty": {
            "type": "string",
            "enum": ["yes", "no", "always"],
            "errorMessage": "must have a value: 'yes', 'no' or 'always'"
          },
          "default_member": {
            "type": "object",
            "properties": {
              "expression": {
                "type": "string",
                "minLength": 1
              },
              "apply_only_when_in_query": {
                "type": "boolean"
              }
            },
            "required": ["expression"]
          }
        }
      }
    },

    "level_attributes": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["label", "unique_name"],
        "anyOf": [
          {
            "required": ["shared_degenerate_columns"],
            "not": {
              "anyOf": [{ "required": ["dataset"] }, { "required": ["name_column"] }, { "required": ["key_columns"] }]
            },
            "errorMessage": "Invalid configuration: Please provide either 'dataset', 'name_column', and 'key_columns' for a single dataset or 'shared_degenerate_columns' for multiple datasets, but not both or neither."
          },
          {
            "required": ["dataset", "name_column", "key_columns"],
            "not": {
              "required": ["shared_degenerate_columns"]
            },
            "errorMessage": {
              "required": "Missing required properties for single-dataset syntax. The properties 'dataset', 'name_column', and 'key_columns' are required.",
              "not": "Invalid configuration: Please provide either 'dataset', 'name_column', and 'key_columns' for a single dataset or 'shared_degenerate_columns' for multiple datasets, but not both or neither."
            }
          }
        ],
        "properties": {
          "label": {
            "type": "string",
            "minLength": 1,
            "maxLength": 128
          },
          "unique_name": {
            "type": "string",
            "minLength": 1,
            "maxLength": 63
          },
          "dataset": {
            "type": "string",
            "minLength": 1,
            "maxLength": 128
          },
          "description": {
            "type": "string",
            "minLength": 1
          },
          "contains_unique_names": {
            "type": "boolean"
          },
          "name_column": {
            "type": "string",
            "minLength": 1
          },
          "key_columns": {
            "type": "array",
            "items": {
              "type": "string",
              "minLength": 1
            }
          },
          "sort_column": {
            "type": "string",
            "minLength": 1
          },
          "is_unique_key": {
            "type": "boolean"
          },
          "shared_degenerate_columns": {
            "type": "array",
            "minItems": 1,
            "maxItems": 128,
            "items": {
              "type": "object",
              "required": ["dataset", "name_column", "key_columns"],
              "properties": {
                "dataset": {
                  "type": "string",
                  "minLength": 1,
                  "maxLength": 128
                },
                "name_column": {
                  "type": "string",
                  "minLength": 1
                },
                "key_columns": {
                  "type": "array",
                  "minItems": 1,
                  "maxItems": 1,
                  "items": {
                    "type": "string",
                    "minLength": 1,
                    "maxLength": 128
                  }
                },
                "sort_column": {
                  "type": "string",
                  "minLength": 1,
                  "maxLength": 128
                },
                "is_unique_key": {
                  "type": "boolean"
                }
              }
            }
          },
          "is_hidden": {
            "type": "boolean"
          },
          "allowed_calcs_for_dma": {
            "type": "array",
            "items": {
              "type": "string",
              "minLength": 1
            }
          },
          "exclude_from_dim_agg": {
            "type": "boolean"
          },
          "is_aggregatable": {
            "type": "boolean"
          },
          "exclude_from_fact_agg": {
            "type": "boolean"
          },
          "custom_empty_member": {
            "type": "object",
            "required": ["key", "name"],
            "properties": {
              "key": {
                "type": "array"
              },
              "name": {
                "type": "string",
                "minLength": 1,
                "maxLength": 128
              }
            }
          },
          "folder": {
            "type": "string",
            "minLength": 1
          },
          "time_unit": {
            "type": "string",
            "enum": [
              "year",
              "halfyear",
              "trimester",
              "quarter",
              "month",
              "week",
              "day",
              "hour",
              "minute",
              "second",
              "undefined"
            ]
          }
        }
      }
    },
    "relationships": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["from", "to", "type"],
        "properties": {
          "unique_name": {
            "type": "string",
            "minLength": 1
          },
          "from": {
            "type": "object",
            "required": ["dataset", "join_columns"],
            "properties": {
              "dataset": {
                "type": "string",
                "minLength": 1,
                "maxLength": 128
              },
              "join_columns": {
                "type": "array",
                "items": {
                  "type": "string",
                  "minLength": 1,
                  "maxLength": 128
                }
              },
              "hierarchy": {
                "type": "string",
                "items": {
                  "type": "string",
                  "minLength": 1
                }
              },
              "level": {
                "type": "string",
                "items": {
                  "type": "string",
                  "minLength": 1,
                  "maxLength": 128
                }
              }
            }
          },
          "to": {
            "type": "object",
            "required": [],
            "oneOf": [
              {
                "required": ["level"],
                "errorMessage": "Missing level prop - please add row_security OR level property"
              },
              {
                "required": ["row_security"],
                "errorMessage": "Missing row_security prop - please add row_security OR level property"
              }
            ],
            "properties": {
              "dimension": {
                "type": "string",
                "minLength": 1,
                "maxLength": 128
              },
              "level": {
                "type": "string",
                "minLength": 1,
                "maxLength": 128
              },
              "row_security": {
                "type": "string",
                "minLength": 1,
                "maxLength": 128
              }
            }
          },
          "type": {
            "type": "string",
            "enum": ["embedded", "snowflake"],
            "errorMessage": "must have a value: 'embedded' or 'snowflake'"
          },
          "role_play": {
            "type": "string",
            "pattern": ".*\\{0\\}.*",
            "errorMessage": "template field must be a string that always contains {0} placeholder. The placeholder indicates where the role-played dimension's name should go."
          }
        }
      }
    },
    "calculation_groups": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["unique_name", "label", "calculated_members"],
        "properties": {
          "unique_name": {
            "type": "string",
            "minLength": 1,
            "maxLength": 128
          },
          "label": {
            "type": "string",
            "minLength": 1,
            "maxLength": 128
          },
          "calculated_members": {
            "type": "array",
            "items": {
              "type": "object",
              "required": ["unique_name"],
              "properties": {
                "unique_name": {
                  "type": "string",
                  "minLength": 1,
                  "maxLength": 128
                },
                "description": {
                  "type": "string",
                  "minLength": 1
                },
                "expression": {
                  "type": "string",
                  "minLength": 1
                },
                "format": {
                  "type": "string",
                  "minLength": 1
                },
                "template": {
                  "type": "string",
                  "enum": [
                    "Current",
                    "Previous",
                    "Current vs Previous",
                    "Current vs Previous Pct",
                    "Next",
                    "Current vs Next",
                    "Current vs Next Pct",
                    "Pct of Total",
                    "Pct of Parent",
                    "Last Year",
                    "Current vs Last Year",
                    "Current vs Last Year Pct",
                    "Year to Date",
                    "Quarter to Date",
                    "Month to Date",
                    "Month Moving Average 3 Month",
                    "Moving Average 30 Period",
                    "Moving Average 5 Period",
                    "Moving Std Dev 30 Period",
                    "Moving Std Dev 5 Period"
                  ]
                },
                "use_input_metric_format": {
                  "type": "boolean"
                }
              },
              "anyOf": [
                {
                  "required": ["expression"],
                  "not": {
                    "required": ["template"]
                  },
                  "errorMessage": "Invalid configuration: Please provide either 'expression' or 'template', but not both or neither."
                },
                {
                  "required": ["template"],
                  "not": {
                    "required": ["expression"]
                  },
                  "errorMessage": {
                    "required": "Missing required properties. Please provide either 'expression' or 'template', but not both or neither.",
                    "not": "Invalid configuration: Please provide either 'expression' or 'template', but not both or neither."
                  }
                }
              ]
            }
          },
          "description": {
            "type": "string",
            "minLength": 1
          },
          "folder": {
            "type": "string",
            "minLength": 1,
            "maxLength": 128
          }
        }
      }
    },
    "unique_name": {
      "type": "string",
      "minLength": 1,
      "maxLength": 128
    },
    "object_type": {
      "const": "dimension"
    }
  }
}
